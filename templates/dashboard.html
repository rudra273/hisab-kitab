
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Transaction Insights</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<style>
    * {
        box-sizing: border-box;
    }
    
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin: 0;
        padding: 0;
        min-height: 100vh;
        color: #1f2937;
    }
    
    /* Navigation Bar */
    .main-nav {
        background: transparent;
        backdrop-filter: none;
        border-bottom: none;
        padding: 16px 0;
        position: sticky;
        top: 0;
        z-index: 1000;
        width: 100%;
    }

    .nav-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .nav-brand {
        font-size: 20px;
        font-weight: 700;
        color: white;
        text-decoration: none;
    }

    .main-nav ul {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        gap: 16px;
    }

    .main-nav ul li a {
        color: rgba(255, 255, 255, 0.85);
        text-decoration: none;
        font-size: 15px;
        font-weight: 500;
        padding: 8px 16px;
        border-radius: 8px;
        transition: background 0.2s ease, color 0.2s ease;
    }

    .main-nav ul li a:hover {
        background: rgba(255, 255, 255, 0.2);
        color: white;
    }

    .main-nav ul li a.active {
        background: rgba(255, 255, 255, 0.95);
        color: #4c51bf;
        box-shadow: 0 2px 8px -2px rgba(0,0,0,0.1);
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 16px;
    }
    
    /* Header */
    .header {
        text-align: center;
        margin-bottom: 32px;
        color: white;
    }
    
    .header h1 {
        font-size: clamp(24px, 5vw, 36px);
        font-weight: 700;
        margin: 0 0 8px 0;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .header p {
        opacity: 0.9;
        font-size: 16px;
        margin: 0;
    }
    
    /* Toolbar */
    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    .btn {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        color: #374151;
        border: 0;
        padding: 12px 20px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px -6px rgba(0, 0, 0, 0.25);
    }
    
    .btn.secondary {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    /* Filters Panel */
    .filters {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 24px;
        margin-bottom: 32px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        overflow: hidden;
    }
    
    .filters.collapsed {
        max-height: 0;
        padding: 0 24px;
        opacity: 0;
        margin-bottom: 0;
        overflow: hidden;
    }
    
    .filter-grid {
        display: grid;
        gap: 20px;
        grid-template-columns: 1fr;
        min-width: 0;
    }
    
    @media (min-width: 640px) {
        .filter-grid { grid-template-columns: repeat(2, 1fr); }
    }
    
    @media (min-width: 1024px) {
        .filter-grid { grid-template-columns: repeat(4, 1fr); }
    }
    
    .field {
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-width: 0;
    }
    
    .field label {
        font-size: 13px;
        font-weight: 600;
        color: #374151;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .field input, .field select {
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        background: white;
        font-size: 14px;
        transition: all 0.2s ease;
        outline: none;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
    }
    
    .field input:focus, .field select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .date-range {
        display: flex;
        gap: 8px;
    }
    
    .date-range input {
        flex: 1;
    }
    
    /* Quick Filter Chips */
    .quick-filters {
        grid-column: 1 / -1;
        margin-top: 8px;
    }
    
    .chips {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .chip {
        padding: 8px 16px;
        background: #f3f4f6;
        border: 2px solid transparent;
        color: #6b7280;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
    }
    
    .chip:hover {
        background: #e5e7eb;
        color: #374151;
    }
    
    .chip.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px -4px rgba(102, 126, 234, 0.4);
    }
    
    /* Summary Cards */
    .summary {
        display: grid;
        gap: 20px;
        margin-bottom: 32px;
        grid-template-columns: 1fr;
    }
    
    @media (min-width: 640px) {
        .summary { grid-template-columns: repeat(2, 1fr); }
    }
    
    @media (min-width: 1024px) {
        .summary { grid-template-columns: repeat(4, 1fr); }
    }
    
    .card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        padding: 24px;
        border-radius: 20px;
        text-align: center;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px -12px rgba(0, 0, 0, 0.15);
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px -12px rgba(0, 0, 0, 0.25);
    }
    
    .card-label {
        font-size: 14px;
        color: #6b7280;
        font-weight: 500;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .card-value {
        font-size: clamp(20px, 4vw, 28px);
        font-weight: 700;
        color: #1f2937;
        margin: 0;
    }
    
    .card-change {
        font-size: 12px;
        margin-top: 4px;
        font-weight: 500;
    }
    
    .positive { color: #10b981; }
    .negative { color: #ef4444; }
    
    /* Charts Section */
    .charts {
        display: grid;
        gap: 24px;
        margin-bottom: 32px;
        grid-template-columns: 1fr;
    }
    
    @media (min-width: 1024px) {
        .charts {
            grid-template-columns: 1fr 1fr;
        }
    }
    
    .chart-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        padding: 24px;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px -12px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
        height: 360px;
        box-sizing: border-box;
        position: relative;
    }
    
    .chart-container:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 40px -12px rgba(0, 0, 0, 0.25);
    }
    
    .chart-title {
        font-size: 16px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .chart-container canvas {
        width: 100% !important;
        height: calc(100% - 24px) !important;
        display: block;
    }

    .chart-container.chart-large {
        height: 420px;
    }
    
    .chart-large {
        grid-column: 1 / -1;
    }
    
    /* Table */
    .table-container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px -12px rgba(0, 0, 0, 0.15);
    }
    
    .table-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .table-title {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }
    
    table th, table td {
        padding: 16px 24px;
        text-align: left;
        border-bottom: 1px solid #f3f4f6;
    }
    
    table th {
        background: #f9fafb;
        font-weight: 600;
        color: #374151;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    table tr:hover {
        background: #f9fafb;
    }
    
    .amount {
        font-weight: 600;
        color: #059669;
    }
    
    .type-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        background: #e0e7ff;
        color: #3730a3;
    }
    
    /* Icon styles */
    .icon {
        width: 16px;
        height: 16px;
        stroke-width: 2;
    }
    
    .icon-sm {
        width: 14px;
        height: 14px;
    }
    
    .icon-lg {
        width: 20px;
        height: 20px;
    }
    
    /* Mobile Responsive Table */
    @media (max-width: 768px) {
        table, table thead, table tbody, table th, table td, table tr {
            display: block;
        }
        
        table thead tr {
            position: absolute;
            top: -9999px;
            left: -9999px;
        }
        
        table tr {
            background: white;
            border-radius: 12px;
            margin-bottom: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        table td {
            border: none;
            position: relative;
            padding: 8px 0;
            text-align: right;
        }
        
        table td::before {
            content: attr(data-label) ": ";
            position: absolute;
            left: 0;
            width: 45%;
            padding-right: 10px;
            white-space: nowrap;
            font-weight: 600;
            color: #6b7280;
            text-align: left;
        }
        
        .table-container {
            padding: 0 16px 16px;
        }
    }
    
    /* Loading States */
    .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        color: #6b7280;
    }
    
    /* Empty States */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6b7280;
    }
    
    .empty-state h3 {
        font-size: 18px;
        margin-bottom: 8px;
        color: #374151;
    }
</style>
</head>
<body>

<nav class="main-nav">
    <div class="nav-container">
        <a href="/" class="nav-brand">Hisab-Kitab</a>
        <ul>
            <li><a href="/dashboard" class="active">Dashboard</a></li>
            <li><a href="/chat">Chat</a></li>
        </ul>
    </div>
</nav>

<div class="container">
    <div class="header">
        <h1>Transaction Insights</h1>
        <p>Monitor your spending patterns and financial activity</p>
    </div>

    <div class="toolbar">
        <button id="toggleFilters" class="btn">
            <i data-lucide="search" class="icon"></i>
            Hide Filters
        </button>
        <button id="resetFilters" class="btn secondary">
            <i data-lucide="rotate-ccw" class="icon"></i>
            Reset All
        </button>
    </div>

    <div id="filtersPanel" class="filters">
        <div class="filter-grid">
            <div class="field">
                <label for="search">
                    <i data-lucide="search" class="icon icon-sm"></i>
                    Search
                </label>
                <input id="search" type="text" placeholder="Search merchant, bank..." />
            </div>
            <div class="field">
                <label for="type">
                    <i data-lucide="bar-chart-3" class="icon icon-sm"></i>
                    Transaction Type
                </label>
                <select id="type">
                    <option value="">All Types</option>
                </select>
            </div>
            <div class="field">
                <label for="bank">
                    <i data-lucide="building-2" class="icon icon-sm"></i>
                    Bank
                </label>
                <select id="bank">
                    <option value="">All Banks</option>
                </select>
            </div>
            <div class="field">
                <label for="merchant">
                    <i data-lucide="store" class="icon icon-sm"></i>
                    Merchant
                </label>
                <select id="merchant">
                    <option value="">All Merchants</option>
                </select>
            </div>
            <div class="field">
                <label for="minAmt">
                    <i data-lucide="indian-rupee" class="icon icon-sm"></i>
                    Min Amount
                </label>
                <input id="minAmt" type="number" inputmode="decimal" placeholder="₹ 0" />
            </div>
            <div class="field">
                <label for="maxAmt">
                    <i data-lucide="indian-rupee" class="icon icon-sm"></i>
                    Max Amount
                </label>
                <input id="maxAmt" type="number" inputmode="decimal" placeholder="₹ No limit" />
            </div>
            <div class="field">
                <label>
                    <i data-lucide="calendar" class="icon icon-sm"></i>
                    Date Range
                </label>
                <div class="date-range">
                    <input id="startDate" type="date" />
                    <input id="endDate" type="date" />
                </div>
            </div>
            <div class="field quick-filters">
                <label>
                    <i data-lucide="zap" class="icon icon-sm"></i>
                    Quick Filters
                </label>
                <div class="chips">
                    <span class="chip" data-range="1">Today</span>
                    <span class="chip" data-range="7">Week</span>
                    <span class="chip" data-range="30">Month</span>
                    <span class="chip" data-range="90">Quarter</span>
                    <span class="chip" data-range="365">Year</span>
                    <span class="chip" data-range="all">All Time</span>
                </div>
            </div>
        </div>
    </div>

    <div class="summary">
        <div class="card">
            <div class="card-label">
                <i data-lucide="credit-card" class="icon"></i>
                Total Spend
            </div>
            <div class="card-value" id="totalSpend">₹0</div>
            <div class="card-change" id="spendChange"></div>
        </div>
        <div class="card">
            <div class="card-label">
                <i data-lucide="trophy" class="icon"></i>
                Top Merchant
            </div>
            <div class="card-value" id="topMerchant">-</div>
            <div class="card-change" id="merchantChange"></div>
        </div>
        <div class="card">
            <div class="card-label">
                <i data-lucide="trending-up" class="icon"></i>
                Transactions
            </div>
            <div class="card-value" id="totalTx">0</div>
            <div class="card-change" id="txChange"></div>
        </div>
        <div class="card">
            <div class="card-label">
                <i data-lucide="calculator" class="icon"></i>
                Average
            </div>
            <div class="card-value" id="avgSpend">₹0</div>
            <div class="card-change" id="avgChange"></div>
        </div>
    </div>

    <div class="charts">
        <div class="chart-container">
            <div class="chart-title">
                <i data-lucide="building-2" class="icon"></i>
                Spending by Bank
            </div>
            <canvas id="bankChart"></canvas>
        </div>
        <div class="chart-container">
            <div class="chart-title">
                <i data-lucide="store" class="icon"></i>
                Top 10 Merchants
            </div>
            <canvas id="merchantChart"></canvas>
        </div>
        <div class="chart-container chart-large">
            <div class="chart-title">
                <i data-lucide="calendar" class="icon"></i>
                Daily Spending Trend
            </div>
            <canvas id="dailyChart"></canvas>
        </div>
    </div>

    <div class="table-container">
        <div class="table-header">
            <h3 class="table-title">
                <i data-lucide="list" class="icon icon-lg"></i>
                Recent Transactions
            </h3>
        </div>
        <table>
            <thead>
                <tr>
                    <th><i data-lucide="user" class="icon icon-sm" style="display: inline; margin-right: 6px;"></i>User</th>
                    <th><i data-lucide="building-2" class="icon icon-sm" style="display: inline; margin-right: 6px;"></i>Bank</th>
                    <th><i data-lucide="indian-rupee" class="icon icon-sm" style="display: inline; margin-right: 6px;"></i>Amount</th>
                    <th><i data-lucide="bar-chart-3" class="icon icon-sm" style="display: inline; margin-right: 6px;"></i>Type</th>
                    <th><i data-lucide="store" class="icon icon-sm" style="display: inline; margin-right: 6px;"></i>Merchant</th>
                    <th><i data-lucide="calendar" class="icon icon-sm" style="display: inline; margin-right: 6px;"></i>Date</th>
                </tr>
            </thead>
            <tbody id="transactionTable">
                <tr><td colspan="6" class="loading">Loading transactions...</td></tr>
            </tbody>
        </table>
    </div>
</div>
<script id="tx-data" type="application/json">{{ transactions | tojson | default([], true) }}</script>

<script>
    // Initialize Lucide icons
    lucide.createIcons();
    
    // Transactions provided by server (fallback to empty array)
    const transactions = JSON.parse(document.getElementById('tx-data')?.textContent || '[]');

    const INR = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 });

    // Elements
    const el = id => document.getElementById(id);
    const searchEl = el('search');
    const typeEl = el('type');
    const bankEl = el('bank');
    const merchantEl = el('merchant');
    const minAmtEl = el('minAmt');
    const maxAmtEl = el('maxAmt');
    const startEl = el('startDate');
    const endEl = el('endDate');

    // Enhanced color palettes
    const bankColors = ["#667eea", "#764ba2", "#f093fb", "#f5576c", "#4facfe", "#00f2fe", "#43e97b", "#38f9d7"];
    const merchantColors = ["#667eea", "#764ba2", "#f093fb", "#f5576c", "#4facfe", "#00f2fe", "#43e97b", "#38f9d7", "#ffecd2", "#fcb69f"];

    // Populate filter selects
    function freqMap(list) {
        const map = new Map();
        list.forEach(v => { const k = v || 'Unknown'; map.set(k, (map.get(k)||0)+1); });
        return Array.from(map.entries()).sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0]));
    }
    function populateSelect(el, entries) { entries.forEach(([v]) => el.insertAdjacentHTML('beforeend', `<option value="${v==='Unknown'?'':v}">${v}</option>`)); }
    populateSelect(typeEl, freqMap(transactions.map(t => t.transaction_type)));
    populateSelect(bankEl, freqMap(transactions.map(t => t.bank)));
    populateSelect(merchantEl, freqMap(transactions.map(t => t.merchant)));

    // Date parsing
    function toDate(t) {
        if (!t.date_received) return null;
        const s = t.date_received.replace(' ', 'T');
        const d = new Date(s);
        return isNaN(d.getTime()) ? null : d;
    }

    // Debounce for smooth filtering
    function debounce(fn, ms) { let to; return (...args) => { clearTimeout(to); to = setTimeout(() => fn(...args), ms); }; }

    // Charts
    let bankChart, merchantChart, dailyChart;
    
    function renderCharts(data) {
        // Bank spending
        const byBank = {};
        const byMerchant = {};
        const byDay = {};
        
        data.forEach(t => {
            const amt = Number(t.amount || 0);
            if (!isNaN(amt)) {
                if (t.bank) byBank[t.bank] = (byBank[t.bank] || 0) + amt;
                if (t.merchant) byMerchant[t.merchant] = (byMerchant[t.merchant] || 0) + amt;
            }
            const d = toDate(t);
            if (d) {
                const key = d.toISOString().slice(0,10);
                byDay[key] = (byDay[key] || 0) + amt;
            }
        });

        const bankCtx = document.getElementById('bankChart');
        const merchantCtx = document.getElementById('merchantChart');
        const dailyCtx = document.getElementById('dailyChart');
        
        if (bankChart) bankChart.destroy();
        if (merchantChart) merchantChart.destroy();
        if (dailyChart) dailyChart.destroy();

        // Bank Chart - Doughnut
        bankChart = new Chart(bankCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(byBank),
                datasets: [{
                    data: Object.values(byBank),
                    backgroundColor: bankColors,
                    borderWidth: 0,
                    cutout: '60%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } },
                    tooltip: {
                        callbacks: {
                            label: ctx => `${ctx.label}: ${INR.format(ctx.raw)}`
                        }
                    }
                }
            }
        });

        // Merchant Chart - Horizontal Bar (Top 10)
        const top10 = Object.entries(byMerchant).sort((a,b)=>b[1]-a[1]).slice(0,10);
        merchantChart = new Chart(merchantCtx, {
            type: 'bar',
            data: { 
                labels: top10.map(m=>m[0]), 
                datasets: [{ 
                    data: top10.map(m=>m[1]), 
                    backgroundColor: merchantColors.slice(0, 10),
                    borderRadius: 8,
                    borderSkipped: false
                }] 
            },
            options: { 
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => `${INR.format(ctx.raw)}`
                        }
                    }
                }, 
                scales: { 
                    x: { beginAtZero: true, grid: { display: false } },
                    y: { grid: { display: false } }
                }
            }
        });

        // Daily Chart - Area
        const dayLabels = Object.keys(byDay).sort();
        const dayData = dayLabels.map(d=>byDay[d]);
        
        dailyChart = new Chart(dailyCtx, {
            type: 'line',
            data: { 
                labels: dayLabels.map(d => new Date(d).toLocaleDateString()), 
                datasets: [{ 
                    label: 'Daily Spend', 
                    data: dayData, 
                    borderColor: '#667eea', 
                    backgroundColor: 'rgba(102, 126, 234, 0.1)', 
                    tension: 0.4, 
                    fill: true,
                    borderWidth: 3,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 6
                }] 
            },
            options: { 
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: ctx => `${INR.format(ctx.raw)}`
                        }
                    }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' } }
                }
            }
        });
    }

    function formatINR(n) { return INR.format(Math.round(n || 0)); }

    const applyFilters = debounce(function applyFiltersImpl() {
        const q = (searchEl.value || '').toLowerCase();
        const fType = typeEl.value;
        const fBank = bankEl.value;
        const fMerchant = merchantEl.value;
        const minAmt = parseFloat(minAmtEl.value);
        const maxAmt = parseFloat(maxAmtEl.value);
        const start = startEl.value ? new Date(startEl.value) : null;
        const end = endEl.value ? new Date(endEl.value + 'T23:59:59') : null;

        const data = transactions.filter(t => {
            const amt = Number(t.amount);
            const safeAmt = isNaN(amt) ? 0 : amt;
            if (fType && t.transaction_type !== fType) return false;
            if (fBank && t.bank !== fBank) return false;
            if (fMerchant && t.merchant !== fMerchant) return false;
            if (!isNaN(minAmt) && !(safeAmt >= minAmt)) return false;
            if (!isNaN(maxAmt) && !(safeAmt <= maxAmt)) return false;
            const d = toDate(t);
            if (start && (!d || d < start)) return false;
            if (end && (!d || d > end)) return false;
            if (q) {
                const hay = `${t.merchant||''} ${t.bank||''} ${t.transaction_type||''} ${t.user_name||''}`.toLowerCase();
                if (!hay.includes(q)) return false;
            }
            return true;
        });

        // Enhanced Summary
        const totalSpend = data.reduce((sum, t) => sum + (isNaN(Number(t.amount))?0:Number(t.amount)), 0);
        const avgSpend = data.length > 0 ? totalSpend / data.length : 0;
        
        document.getElementById('totalSpend').textContent = formatINR(totalSpend);
        document.getElementById('totalTx').textContent = data.length.toLocaleString();
        document.getElementById('avgSpend').textContent = formatINR(avgSpend);
        
        const merchantSpend = {};
        data.forEach(t => { 
            if (t.merchant) merchantSpend[t.merchant] = (merchantSpend[t.merchant] || 0) + (isNaN(Number(t.amount))?0:Number(t.amount)); 
        });
        const top = Object.entries(merchantSpend).sort((a,b)=>b[1]-a[1])[0];
        document.getElementById('topMerchant').textContent = top ? top[0] : 'None';

        // Enhanced Table with better formatting
        const tbody = document.getElementById('transactionTable');
        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><h3>No transactions found</h3><p>Try adjusting your filters</p></td></tr>';
        } else {
            tbody.innerHTML = '';
            data.slice(0, 50).forEach(t => { // Show max 50 for performance
                const date = toDate(t);
                const formattedDate = date ? date.toLocaleDateString('en-IN', { 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : t.date_received;
                
                tbody.insertAdjacentHTML('beforeend', `
                    <tr>
                        <td data-label="User">${t.user_name||'-'}</td>
                        <td data-label="Bank">${t.bank||'-'}</td>
                        <td data-label="Amount" class="amount">${formatINR(isNaN(Number(t.amount))?0:Number(t.amount))}</td>
                        <td data-label="Type"><span class="type-badge">${t.transaction_type||'-'}</span></td>
                        <td data-label="Merchant">${t.merchant||'-'}</td>
                        <td data-label="Date">${formattedDate}</td>
                    </tr>
                `);
            });
            
            if (data.length > 50) {
                tbody.insertAdjacentHTML('beforeend', `
                    <tr><td colspan="6" style="text-align:center; padding:20px; color:#6b7280; font-style:italic;">
                        Showing first 50 of ${data.length} transactions
                    </td></tr>
                `);
            }
        }

        // Charts
        renderCharts(data);
    }, 120);

    // Quick range chips
    document.querySelectorAll('.chip').forEach(ch => {
        ch.addEventListener('click', () => {
            document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
            ch.classList.add('active');
            const val = ch.dataset.range;
            if (val === 'all') {
                startEl.value = '';
                endEl.value = '';
            } else {
                const days = parseInt(val);
                const end = new Date();
                const start = new Date();
                start.setDate(end.getDate() - days + 1);
                startEl.valueAsDate = start;
                endEl.valueAsDate = end;
            }
            applyFilters();
        });
    });

    // Reset filters
    document.getElementById('resetFilters').addEventListener('click', () => {
        searchEl.value = '';
        typeEl.value = '';
        bankEl.value = '';
        merchantEl.value = '';
        minAmtEl.value = '';
        maxAmtEl.value = '';
        startEl.value = '';
        endEl.value = '';
        document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
        applyFilters();
    });

    // Toggle filters visibility
    const toggleBtn = document.getElementById('toggleFilters');
    const filtersPanel = document.getElementById('filtersPanel');
    toggleBtn.addEventListener('click', () => {
        const collapsed = filtersPanel.classList.toggle('collapsed');
        const icon = toggleBtn.querySelector('i');
        const text = toggleBtn.childNodes[1];
        
        if (collapsed) {
            icon.setAttribute('data-lucide', 'search');
            text.textContent = ' Show Filters';
        } else {
            icon.setAttribute('data-lucide', 'search');
            text.textContent = ' Hide Filters';
        }
        
        // Reinitialize icons
        lucide.createIcons();
    });

    // Bind filter events
    [searchEl, typeEl, bankEl, merchantEl, minAmtEl, maxAmtEl, startEl, endEl].forEach(elm => {
        elm.addEventListener('input', () => { 
            if (elm===startEl||elm===endEl) { 
                document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); 
            } 
            applyFilters(); 
        });
        elm.addEventListener('change', () => { 
            if (elm===startEl||elm===endEl) { 
                document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); 
            } 
            applyFilters(); 
        });
    });

    // Initialize with Month view by default
    document.addEventListener('DOMContentLoaded', () => {
        const monthChip = Array.from(document.querySelectorAll('.chip')).find(c=>c.dataset.range==='30');
        if (monthChip) { 
            monthChip.click(); 
        } else { 
            applyFilters(); 
        }
    });

    // Add some smooth animations for mobile interactions
    if ('ontouchstart' in window) {
        document.querySelectorAll('.card, .chart-container, .btn').forEach(el => {
            el.addEventListener('touchstart', function() {
                this.style.transform = 'scale(0.98)';
            });
            el.addEventListener('touchend', function() {
                setTimeout(() => {
                    this.style.transform = '';
                }, 150);
            });
        });
    }
</script>

</body>
</html>